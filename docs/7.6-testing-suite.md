# Testing Suite Overview

This document outlines the refreshed PHPUnit suite organization and the current two-lane strategy for seeded regression plus fresh-install confidence checks.

## ğŸ§± Test Architecture

| Layer | Location | Base class | Description |
| --- | --- | --- | --- |
| Core Unit | `tests/TestCase/Core/Unit` | `BaseTestCase` | Fast-running unit and table/service tests that operate purely on PHP objects or direct ORM calls. |
| Core Feature | `tests/TestCase/Core/Feature` | `HttpIntegrationTestCase` | HTTP-centric smoke tests that exercise controllers or routes without complex setup. |
| Plugins | `tests/TestCase/Plugins` | `PluginIntegrationTestCase` | Plugin-focused tests that access plugin tables or services while sharing the same seeded database. |

Support helpers live in `tests/TestCase/Support`:

- `SeedManager` â€“ centralizes loading `../dev_seed_clean.sql` to the `test` connection.
- `HttpIntegrationTestCase` â€“ thin HTTP feature base (extends `BaseTestCase` + `IntegrationTestTrait`).
- `PluginIntegrationTestCase` â€“ auto-loads the plugin under test before running assertions.

## ğŸŒ± Seeded Regression Lane

PHPUnit suites load `/workspaces/KMP/dev_seed_clean.sql` during `tests/bootstrap.php`. `SeedManager` ensures the SQL file is applied once per run and exposes a `reset()` helper for heavy data mutation scenarios.

When extending `BaseTestCase`, call `$this->reseedDatabase()` if your test needs a full reset after destructive operations.

## ğŸš€ Running Tests

| Command | Purpose |
| --- | --- |
| `vendor/bin/phpunit --testsuite core-unit` | Run fast unit/service coverage. |
| `vendor/bin/phpunit --testsuite core-feature` | Execute HTTP smoke tests. |
| `vendor/bin/phpunit --testsuite plugins` | Run cross-plugin coverage (includes `tests/TestCase/Plugins` and plugin-owned suites). |
| `vendor/bin/phpunit tests/TestCase/Core/Feature/Members/MembersLoginPageTest.php` | Target a single file. |
| `vendor/bin/phpunit --filter MembersTableSeedTest` | Target a single class/method. |
| `cd app && npm run test:ui` | Run existing seed-based Playwright/Bdd regression lane. |
| `cd app && npm run test:ui:install:smoke` | Reset to blank DB, complete installer flow, then run fresh-install UI smoke checks. |

> ğŸ’¡ Need the old â€œeverythingâ€ run? Use `vendor/bin/phpunit --testsuite all`.

## ğŸ†• Fresh-install Smoke Lane (Installer-first)

Use the installer-first smoke lane to validate that a brand-new kingdom can complete setup and immediately use critical features without relying on hidden seed state.

`npm run test:ui:install:smoke` performs:

1. `dev-reset-installer.sh --no-archive` (blank database + cleared installer state)
2. `install_test.js` (full web installer walkthrough)
3. `php bin/cake.php configure_install_test_data` (idempotent post-install capability setup)
4. Playwright smoke checks (`tests/ui/install-smoke.spec.js` + login BDD flow + first activity request/approval-request scenario)

This lane is intentionally smaller than seed regression and is intended for PR gating while deeper feature suites are migrated off hardcoded seed assumptions.

### Current migration matrix

| Suite/File | Current dependency profile | Fresh-install status |
| --- | --- | --- |
| `tests/TestCase/**` via `tests/bootstrap.php` | Seed-first (`SeedManager` + `dev_seed_clean.sql`) | Legacy lane (kept for regression) |
| `tests/ui/bdd/@auth/UserLogin.feature` | Uses installer-default admin credentials (`admin@test.com`) | Installer-safe |
| `tests/ui/bdd/@activities/*` | Uses configured post-install capability data (`configure_install_test_data`) | Migrating (configurator-backed, selectors still being hardened) |
| `tests/ui/install-smoke.spec.js` | Installer bootstrap only; no deep seed assumptions | Installer-first smoke lane |
| `tests/Playwright/*.spec.js` | Hardcoded legacy login/routes (`/users/login`, `admin@example.com`) | Seed-coupled / legacy (needs refactor before installer lane use) |

## ğŸ§ª Starter Tests

- `Core/Unit/Model/MembersTableSeedTest` â€“ verifies the super-user seed and duplicate email guardrails.
- `Core/Feature/Members/MembersLoginPageTest` â€“ confirms anonymous access to `/members/login` remains healthy.
- `Plugins/Awards/Feature/RecommendationsSeedTest` â€“ proves Awards plugin tables are reachable using the shared seed.

These examples demonstrate how to:

1. Depend on canonical seed accounts defined in `/README.md`.
2. Share HTTP helpers and plugin loaders.
3. Keep new tests isolated with automatic transactions from `BaseTestCase`.

## ğŸ“ˆ Extending the Suite

1. **Pick a layer** (unit vs feature vs plugin) and drop the file in the matching folder.
2. **Extend the correct base** (`BaseTestCase`, `HttpIntegrationTestCase`, or `PluginIntegrationTestCase`).
3. **Choose a lane intentionally**:
   - Seeded lane for broad legacy regression and existing fixture-heavy assumptions
   - Installer-first lane for tests that must prove reproducibility from a blank install
4. **Leverage helpers, not hidden state**: prefer explicit setup/configuration helpers in new tests over hardcoded seed-only assumptions.
5. **Name tests clearly** â€“ the suite naming convention enables `--testsuite` filtering.

## ğŸ”„ Legacy Tests

Existing suites under `tests/TestCase/Controller`, `Model`, `Services`, etc., remain runnable and are included in `core-unit`, `core-feature`, or `all`. Migrate legacy coverage into the new layout over time for the cleanest experience.

Happy testing! ğŸ§ª
