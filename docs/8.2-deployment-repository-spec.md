# 8.2 Deployment Repository Specification

This document defines the GitHub Releases contract consumed by KMP's in-app updater.

## Repository requirements

- Publish application updates as GitHub Releases in a single repository.
- Attach an installable `.zip` package asset to each release.
- Attach a matching `.zip.sha256` asset whose content includes the zip SHA-256 hash.
- If no assets are attached, the updater falls back to GitHub's generated source archive URL.

## Release-train tags

KMP uses AppSetting `Updater.Channel` as the release-train selector and matches release tags using these rules:

- Supported channels: `stable`, `beta`, `dev`, `nightly`
- Exact channel match: `<channel>`
- Prefix match: `<channel>/...`, `<channel>-...`, or `<channel>_...`
- For `stable`, plain semver tags like `v25.11.05` also match

Examples:

- `stable`: `v25.11.05`, `stable/v25.11.05`
- `beta`: `beta/v25.11.06-rc.1`, `beta-25.11.06-rc.1`

## KMP configuration

Set the GitHub source in `app.php` (or override in `app_local.php`):

```php
'Updater' => [
    'githubRepository' => 'Ansteorra/KMP-deployment',
]
```

Set the update-check channel via AppSetting `Updater.Channel` (default: `stable`).
The Updates page uses a Stimulus controller to call GitHub Releases JSON directly in the browser, checks on load, and changing channel auto-saves + auto-checks.
If the default Cake `TMP` path is not writable in your deployment, set `UPDATER_RUNTIME_DIR` to a writable absolute path for updater lock and temp artifacts.

## Installed release identity (hash/tag)

To enable reliable "you are on this release" checks, package builds should include:

- `app/config/release_hash.txt` - the build/source hash (typically git commit SHA)
- `app/config/release_tag.txt` - the release tag (for example `nightly/v1.4.2`)

The updater compares installed identity against the latest release identity (`.zip.sha256` content preferred, then zip asset `digest`, then `target_commitish`, then tag fallback) to report whether the installation matches the latest release.  
It also validates release integrity by comparing the parsed `.zip.sha256` hash to the zip asset `digest` hash from GitHub metadata.

## In-place update execution

When an admin clicks **Update now**, KMP runs a server-side pipeline that:

1. Resolves the latest channel-matching release from GitHub.
2. Downloads the package zip and verifies SHA-256 integrity against release metadata.
3. Extracts and synchronizes package files into the installation.
4. Runs `bin/cake updateDatabase` and `bin/cake cache clear_all`.
5. Writes `app/config/release_hash.txt` and `app/config/release_tag.txt` for installed identity tracking.

The sync intentionally preserves local runtime/state paths such as:

- `app/config/.env`
- `app/config/app_local.php`
- `app/tmp`
- `app/logs`
- `app/images/uploaded`
